
#region Initialize variables

$AccountsCSVPath = "C:\Users\Administrator\Documents\Accounts.csv"
$ExportPath = "C:\Users\Administrator\Documents\Create-AllowedSafes_Output_" + (Get-Date -Format "MM-dd HHMM") + ".csv"
$PlatformSafe = @{}
$PlatformRegex = @{}
$header = "SafeName","PolicyID"


#endregion


#region Functions
Function Get-Type($input){ write-host ("The Object " + $input + " has type of " + $input.GetType()) }

Function Build-AllowedSafesStr{
    param (
        [Parameter(Mandatory = $true)]
        [String[]]
        $safeNames
    )

    # Defining the initial 
    Begin{
        $regexInit = "^("
        $regexTerm = ")$"
    }

    Process{
        [String]$allowedSafes = $regexInit
        ForEach($Safe in $safeNames){
            $allowedSafes = ($allowedSafes += ($Safe + "|"))
        }

        # removing trailing pipe and finalizing RegEx for return
        $allowedSafes = $allowedSafes.Substring(0,$allowedSafes.Length-1) + $regexTerm

        $allowedSafes
    }  
}

#endregion


#$i = 0
# Build hashtable of Platforms and all associated safes
Import-CSV -Path $AccountsCSVPath | %{
    $obj = $_
    $i += 1
    #if($i -gt 5000){break}
    if($PlatformSafe.ContainsKey($obj.SafeName)){
        If($PlatformSafe[$Obj.Safename] -Contains($obj.PolicyID) -eq $false){
            try{$PlatformSafe.($obj.safename) += $obj.PolicyID}
            catch{ write-host ("Policy Add ERROR`n" + $_ )}
            }
    }
    Else{
        try{ $PlatformSafe.Add($Obj.SafeName,[System.Array]$obj.policyID) }
        catch{ write-host ("Error with adding new safe`n" + $_) }
    }
}

$PlatformSafe.Keys | %{ 
    Try{$PlatformRegex.Add($_,(Build-AllowedSafesStr -SafeNames $PlatformSafe.$_))}
    Catch{ write-host ("error with RegexArrayAdd`n" + $_) } 
    }

# Export results to CSV File
Try{$PlatformRegex.GetEnumerator() | select name,value | ConvertTo-Csv | Out-File -FilePath $ExportPath}
catch{ write-host $_ }

